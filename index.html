<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marathon Training App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/sortablejs@1.15.0/Sortable.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        longRun: '#ef4444',
                        tempoRun: '#f59e0b',
                        speedRun: '#10b981',
                        easyRun: '#3b82f6'
                    },
                    animation: {
                        'bounce-in': 'bounceIn 0.6s ease-out',
                        'pulse-glow': 'pulseGlow 2s infinite',
                        'confetti': 'confetti 3s ease-out',
                        'medal-earn': 'medalEarn 1s ease-out',
                        'level-up': 'levelUp 2s ease-out',
                        'xp-gain': 'xpGain 1s ease-out',
                        'streak-fire': 'streakFire 1.5s ease-in-out infinite'
                    },
                    keyframes: {
                        bounceIn: {
                            '0%': { transform: 'scale(0.3)', opacity: '0' },
                            '50%': { transform: 'scale(1.05)' },
                            '70%': { transform: 'scale(0.9)' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        },
                        pulseGlow: {
                            '0%, 100%': { boxShadow: '0 0 5px rgba(93, 92, 222, 0.5)' },
                            '50%': { boxShadow: '0 0 20px rgba(93, 92, 222, 0.8)' }
                        },
                        confetti: {
                            '0%': { transform: 'translateY(-100vh) rotate(0deg)', opacity: '1' },
                            '100%': { transform: 'translateY(100vh) rotate(720deg)', opacity: '0' }
                        },
                        medalEarn: {
                            '0%': { transform: 'scale(0) rotate(-180deg)', opacity: '0' },
                            '50%': { transform: 'scale(1.2) rotate(0deg)', opacity: '1' },
                            '100%': { transform: 'scale(1) rotate(0deg)', opacity: '1' }
                        },
                        levelUp: {
                            '0%': { transform: 'scale(1)', textShadow: '0 0 0px #FFD700' },
                            '50%': { transform: 'scale(1.1)', textShadow: '0 0 20px #FFD700' },
                            '100%': { transform: 'scale(1)', textShadow: '0 0 0px #FFD700' }
                        },
                        xpGain: {
                            '0%': { transform: 'translateY(0)', opacity: '1' },
                            '100%': { transform: 'translateY(-30px)', opacity: '0' }
                        },
                        streakFire: {
                            '0%, 100%': { transform: 'scale(1) rotate(-2deg)' },
                            '50%': { transform: 'scale(1.1) rotate(2deg)' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .workout-card {
            transition: all 0.2s ease;
        }
        .workout-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .sortable-ghost {
            opacity: 0.4;
        }
        .sortable-chosen {
            transform: rotate(5deg);
        }
        .confetti-piece {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #5D5CDE;
            animation: confetti 3s ease-out forwards;
        }
        .celebration-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }
        .xp-bar {
            background: linear-gradient(90deg, #FFD700, #FFA500);
            transition: width 0.8s ease-out;
        }
        .challenge-glow {
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.5);
            animation: pulseGlow 2s infinite;
        }
        .record-badge {
            background: linear-gradient(45deg, #FFD700, #FF6B35);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-white min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- Header -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
            <div class="text-center sm:text-left">
                <h1 class="text-3xl font-bold text-primary">Marathon Training</h1>
                <div class="flex items-center gap-3 mt-2">
                    <div class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-3 py-1 rounded-full font-bold text-sm">
                        Level <span id="currentLevel">1</span>
                    </div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">
                        <span id="currentXP">0</span> / <span id="nextLevelXP">100</span> XP
                    </div>
                </div>
                <div class="w-48 bg-gray-200 dark:bg-gray-700 rounded-full h-2 mt-1">
                    <div id="xpBar" class="xp-bar h-2 rounded-full" style="width: 0%"></div>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <select id="planDuration" class="px-4 py-2 text-base border rounded-lg dark:bg-gray-800 dark:border-gray-600">
                    <option value="40">40 Week Plan</option>
                    <option value="32">32 Week Plan</option>
                    <option value="24">24 Week Plan</option>
                    <option value="16">16 Week Plan</option>
                </select>
                <button id="challengesBtn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition relative challenge-glow">
                    üéØ Challenges
                    <span id="newChallengeBadge" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden animate-pulse">!</span>
                </button>
                <button id="achievementsBtn" class="bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600 transition relative">
                    üèÜ Achievements
                    <span id="newAchievementBadge" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden animate-pulse">!</span>
                </button>
                <button id="paceSettings" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition">
                    Pace Settings
                </button>
            </div>
        </div>

        <!-- Enhanced Progress Dashboard -->
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 mb-6">
            <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-4 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold">Experience</h3>
                        <p id="totalXP" class="text-2xl font-bold">0 XP</p>
                        <p class="text-xs opacity-80">+<span id="streakMultiplier">1.0</span>x multiplier</p>
                    </div>
                    <div class="text-3xl">‚≠ê</div>
                </div>
            </div>
            <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-4 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold">Streak</h3>
                        <p id="currentStreak" class="text-2xl font-bold">0 days</p>
                        <p class="text-xs opacity-80">Best: <span id="longestStreak">0</span> days</p>
                    </div>
                    <div id="streakIcon" class="text-3xl">üî•</div>
                </div>
            </div>
            <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-4 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold">Distance</h3>
                        <p id="totalDistance" class="text-2xl font-bold">0 km</p>
                        <p class="text-xs opacity-80">Personal best: <span id="longestRun">0</span>km</p>
                    </div>
                    <div class="text-3xl">üèÉ</div>
                </div>
            </div>
            <div class="bg-gradient-to-br from-orange-500 to-orange-600 text-white p-4 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold">Achievements</h3>
                        <p id="achievementCount" class="text-2xl font-bold">0/42</p>
                        <p class="text-xs opacity-80">Weekly streak: <span id="weeklyStreak">0</span></p>
                    </div>
                    <div class="text-3xl">üèÜ</div>
                </div>
            </div>
        </div>

        <!-- Daily & Weekly Challenges -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
            <div class="bg-gradient-to-r from-green-400 to-green-600 text-white p-4 rounded-lg">
                <h3 class="font-bold mb-2 flex items-center gap-2">
                    üéØ Daily Challenge
                    <span id="dailyChallengeTimer" class="text-xs bg-white bg-opacity-20 px-2 py-1 rounded"></span>
                </h3>
                <div id="dailyChallengeContent">
                    <p id="dailyChallengeDesc" class="text-sm opacity-90 mb-2">Complete any workout today</p>
                    <div class="flex justify-between items-center">
                        <span class="text-sm">Reward: <span id="dailyChallengeReward">+50 XP</span></span>
                        <span id="dailyChallengeStatus" class="text-xs bg-white bg-opacity-20 px-2 py-1 rounded">Active</span>
                    </div>
                </div>
            </div>
            <div class="bg-gradient-to-r from-purple-400 to-purple-600 text-white p-4 rounded-lg">
                <h3 class="font-bold mb-2 flex items-center gap-2">
                    üèÜ Weekly Challenge
                    <span id="weeklyChallengeTimer" class="text-xs bg-white bg-opacity-20 px-2 py-1 rounded"></span>
                </h3>
                <div id="weeklyChallengeContent">
                    <p id="weeklyChallengeDesc" class="text-sm opacity-90 mb-2">Complete 3 workouts this week</p>
                    <div class="flex justify-between items-center">
                        <span class="text-sm">Reward: <span id="weeklyChallengeReward">+200 XP</span></span>
                        <span id="weeklyChallengeStatus" class="text-xs bg-white bg-opacity-20 px-2 py-1 rounded">
                            <span id="weeklyProgress">0</span>/<span id="weeklyGoal">3</span>
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Week Progress -->
        <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg mb-6">
            <h3 class="font-semibold mb-3 flex items-center gap-2">
                Week Progress
                <span id="weekProgressPercent" class="text-sm text-gray-600 dark:text-gray-400">(0%)</span>
                <span id="motivationalMessage" class="text-sm text-primary font-medium ml-auto"></span>
            </h3>
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 mb-3">
                <div id="weekProgressBar" class="bg-gradient-to-r from-primary to-purple-600 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            <div class="grid grid-cols-3 gap-4 text-sm">
                <div class="text-center">
                    <div class="font-semibold" id="completedWorkouts">0</div>
                    <div class="text-gray-600 dark:text-gray-400">Completed</div>
                </div>
                <div class="text-center">
                    <div class="font-semibold" id="weekDistance">0 km</div>
                    <div class="text-gray-600 dark:text-gray-400">This Week</div>
                </div>
                <div class="text-center">
                    <div class="font-semibold" id="weekXP">0 XP</div>
                    <div class="text-gray-600 dark:text-gray-400">Experience</div>
                </div>
            </div>
        </div>

        <!-- Week Navigation -->
        <div class="flex items-center justify-between mb-6 bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
            <button id="prevWeek" class="bg-gray-200 dark:bg-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                ‚Üê Previous
            </button>
            <div class="text-center">
                <h2 id="weekTitle" class="text-xl font-semibold">Week 1</h2>
                <p id="weekDates" class="text-gray-600 dark:text-gray-400 text-sm"></p>
            </div>
            <button id="nextWeek" class="bg-gray-200 dark:bg-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                Next ‚Üí
            </button>
        </div>

        <!-- Calendar Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-7 gap-4 mb-6">
            <div class="lg:col-span-7">
                <div class="grid grid-cols-1 sm:grid-cols-3 lg:grid-cols-7 gap-4" id="calendarGrid">
                    <!-- Calendar days will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Legend -->
        <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
            <h3 class="font-semibold mb-3">Workout Types & Rewards</h3>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-longRun rounded"></div>
                    <span class="text-sm">Long Run (50 XP)</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-speedRun rounded"></div>
                    <span class="text-sm">Speed/Interval (40 XP)</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-tempoRun rounded"></div>
                    <span class="text-sm">Tempo Run (30 XP)</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-easyRun rounded"></div>
                    <span class="text-sm">Easy Run (20 XP)</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Challenges Modal -->
    <div id="challengesModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold">üéØ Challenges & Records</h3>
                <button id="closeChallengesModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                    <h4 class="text-xl font-semibold mb-4">üèÖ Personal Records</h4>
                    <div class="space-y-3" id="personalRecords">
                        <!-- Personal records will be populated here -->
                    </div>
                </div>
                <div>
                    <h4 class="text-xl font-semibold mb-4">üéñÔ∏è Progress Milestones</h4>
                    <div class="space-y-3" id="progressMilestones">
                        <!-- Progress milestones will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Achievements Modal -->
    <div id="achievementsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold">üèÜ Achievements & Medals</h3>
                <button id="closeAchievementsModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <div class="mb-4">
                <div class="flex gap-2 flex-wrap">
                    <button class="achievement-filter-btn bg-primary text-white px-3 py-1 rounded text-sm" data-category="all">All</button>
                    <button class="achievement-filter-btn bg-gray-200 dark:bg-gray-700 px-3 py-1 rounded text-sm" data-category="progress">Progress</button>
                    <button class="achievement-filter-btn bg-gray-200 dark:bg-gray-700 px-3 py-1 rounded text-sm" data-category="consistency">Consistency</button>
                    <button class="achievement-filter-btn bg-gray-200 dark:bg-gray-700 px-3 py-1 rounded text-sm" data-category="performance">Performance</button>
                    <button class="achievement-filter-btn bg-gray-200 dark:bg-gray-700 px-3 py-1 rounded text-sm" data-category="special">Special</button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="achievementsList">
                <!-- Achievements will be populated here -->
            </div>
        </div>
    </div>

    <!-- Pace Settings Modal -->
    <div id="paceModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg max-w-md w-full mx-4">
            <h3 class="text-xl font-semibold mb-4">Pace Settings</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Long Run Pace (min:sec/km)</label>
                    <input type="text" id="longRunPace" value="6:00" class="w-full px-3 py-2 text-base border rounded-lg dark:bg-gray-700 dark:border-gray-600" placeholder="6:00">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Tempo Run Pace (min:sec/km)</label>
                    <input type="text" id="tempoRunPace" value="5:30" class="w-full px-3 py-2 text-base border rounded-lg dark:bg-gray-700 dark:border-gray-600" placeholder="5:30">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Speed/Interval Pace (min:sec/km)</label>
                    <input type="text" id="speedRunPace" value="5:00" class="w-full px-3 py-2 text-base border rounded-lg dark:bg-gray-700 dark:border-gray-600" placeholder="5:00">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Easy Run Pace (min:sec/km)</label>
                    <input type="text" id="easyRunPace" value="6:30" class="w-full px-3 py-2 text-base border rounded-lg dark:bg-gray-700 dark:border-gray-600" placeholder="6:30">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Marathon Goal Pace (min:sec/km)</label>
                    <input type="text" id="marathonPace" value="5:41" class="w-full px-3 py-2 text-base border rounded-lg dark:bg-gray-700 dark:border-gray-600" placeholder="5:41">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button id="savePaces" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition flex-1">
                    Save
                </button>
                <button id="closePaceModal" class="bg-gray-300 dark:bg-gray-600 px-4 py-2 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500 transition flex-1">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Workout Detail Modal -->
    <div id="workoutModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h3 id="workoutTitle" class="text-xl font-semibold mb-4">Workout Details</h3>
            <div id="workoutContent" class="mb-6">
                <!-- Workout details will be populated here -->
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Actual Distance (km)</label>
                    <input type="number" id="actualDistance" step="0.1" min="0" class="w-full px-3 py-2 text-base border rounded-lg dark:bg-gray-700 dark:border-gray-600">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Average Pace (min:sec/km)</label>
                    <input type="text" id="actualPace" class="w-full px-3 py-2 text-base border rounded-lg dark:bg-gray-700 dark:border-gray-600" placeholder="6:00">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Effort Level (1-10)</label>
                    <div class="flex gap-2">
                        <input type="range" id="effortLevel" min="1" max="10" value="5" class="flex-1">
                        <span id="effortValue" class="text-sm font-medium w-8">5</span>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Notes</label>
                    <textarea id="workoutNotes" rows="3" class="w-full px-3 py-2 text-base border rounded-lg dark:bg-gray-700 dark:border-gray-600" placeholder="How did the workout feel?"></textarea>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button id="completeWorkout" class="bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-3 rounded-lg hover:from-green-600 hover:to-green-700 transition flex-1 font-semibold text-lg animate-pulse-glow">
                    üéâ Complete Workout
                </button>
                <button id="closeWorkoutModal" class="bg-gray-300 dark:bg-gray-600 px-4 py-2 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500 transition">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Level Up Modal -->
    <div id="levelUpModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-lg max-w-md w-full mx-4 text-center animate-bounce-in">
            <div class="text-6xl mb-4 animate-level-up">üåü</div>
            <h3 class="text-3xl font-bold mb-2 text-yellow-500 animate-level-up">LEVEL UP!</h3>
            <h4 class="text-xl font-semibold mb-2">You reached Level <span id="newLevel">2</span>!</h4>
            <p class="text-gray-600 dark:text-gray-400 mb-4">Your dedication is paying off!</p>
            <div class="text-lg font-semibold text-primary mb-6">Multiplier increased to <span id="newMultiplier">1.1</span>x!</div>
            <button id="closeLevelUpModal" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary/90 transition">
                Continue Training! üí™
            </button>
        </div>
    </div>

    <!-- Achievement Earned Modal -->
    <div id="achievementEarnedModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-lg max-w-md w-full mx-4 text-center animate-bounce-in">
            <div class="text-6xl mb-4 animate-medal-earn" id="earnedMedalIcon">üèÜ</div>
            <h3 class="text-2xl font-bold mb-2 text-yellow-500">Achievement Unlocked!</h3>
            <h4 id="earnedAchievementTitle" class="text-xl font-semibold mb-2"></h4>
            <p id="earnedAchievementDesc" class="text-gray-600 dark:text-gray-400 mb-4"></p>
            <div class="text-lg font-semibold text-primary mb-6">+<span id="earnedXP">0</span> XP!</div>
            <button id="closeAchievementModal" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary/90 transition">
                Awesome! üéâ
            </button>
        </div>
    </div>

    <!-- Challenge Complete Modal -->
    <div id="challengeCompleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-lg max-w-md w-full mx-4 text-center animate-bounce-in">
            <div class="text-6xl mb-4">üéØ</div>
            <h3 class="text-2xl font-bold mb-2 text-green-500">Challenge Complete!</h3>
            <h4 id="completedChallengeTitle" class="text-xl font-semibold mb-2"></h4>
            <div class="text-lg font-semibold text-primary mb-6">+<span id="challengeXP">0</span> XP Bonus!</div>
            <button id="closeChallengeModal" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary/90 transition">
                Keep Going! üöÄ
            </button>
        </div>
    </div>

    <!-- Celebration Overlay -->
    <div id="celebrationOverlay" class="celebration-overlay hidden"></div>

    <script>
        // Dark mode setup
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // App State
        let currentWeek = 1;
        let trainingPlan = {};
        let completedWorkouts = new Set();
        let paces = {
            longRun: '6:00',
            tempoRun: '5:30',
            speedRun: '5:00',
            easyRun: '6:30',
            marathon: '5:41'
        };
        let workoutHistory = {};
        let gameStats = {
            totalPoints: 0,
            experience: 0,
            level: 1,
            currentStreak: 0,
            longestStreak: 0,
            totalDistance: 0,
            lastWorkoutDate: null,
            achievements: new Set(),
            newAchievements: [],
            weeklyGoalStreak: 0,
            longestWeeklyStreak: 0,
            personalRecords: {
                fastestPace: null,
                longestRun: 0,
                mostXPInDay: 0,
                mostXPInWeek: 0
            },
            dailyChallenge: null,
            weeklyChallenge: null,
            lastChallengeReset: null
        };

        // Enhanced Achievements system with categories
        const achievements = {
            // Progress Category
            firstWorkout: { icon: 'üéØ', title: 'Getting Started', desc: 'Complete your first workout', xp: 50, category: 'progress', check: () => completedWorkouts.size >= 1 },
            earlyBird: { icon: 'üåÖ', title: 'Early Bird', desc: 'Complete 5 workouts', xp: 100, category: 'progress', check: () => completedWorkouts.size >= 5 },
            dedicated: { icon: 'üí™', title: 'Dedicated Runner', desc: 'Complete 10 workouts', xp: 200, category: 'progress', check: () => completedWorkouts.size >= 10 },
            warrior: { icon: 'üó°Ô∏è', title: 'Training Warrior', desc: 'Complete 25 workouts', xp: 400, category: 'progress', check: () => completedWorkouts.size >= 25 },
            veteran: { icon: 'üéñÔ∏è', title: 'Veteran Runner', desc: 'Complete 50 workouts', xp: 800, category: 'progress', check: () => completedWorkouts.size >= 50 },
            
            // Consistency Category  
            consistent: { icon: 'üî•', title: 'Consistency King', desc: 'Maintain a 7-day streak', xp: 300, category: 'consistency', check: () => gameStats.currentStreak >= 7 },
            fireStarter: { icon: 'üöÄ', title: 'Fire Starter', desc: 'Maintain a 14-day streak', xp: 500, category: 'consistency', check: () => gameStats.longestStreak >= 14 },
            unstoppable: { icon: '‚ö°', title: 'Unstoppable', desc: 'Maintain a 21-day streak', xp: 750, category: 'consistency', check: () => gameStats.longestStreak >= 21 },
            perfectWeek: { icon: '‚≠ê', title: 'Perfect Week', desc: 'Complete all workouts in a week', xp: 400, category: 'consistency', check: () => checkPerfectWeek() },
            weeklyChampion: { icon: 'üëë', title: 'Weekly Champion', desc: 'Complete 3 perfect weeks', xp: 600, category: 'consistency', check: () => gameStats.weeklyGoalStreak >= 3 },
            
            // Performance Category
            centurion: { icon: 'üíØ', title: 'Centurion', desc: 'Run 100km total', xp: 400, category: 'performance', check: () => gameStats.totalDistance >= 100 },
            halfMarathoner: { icon: 'üèÉ', title: 'Half Marathoner', desc: 'Run 250km total', xp: 600, category: 'performance', check: () => gameStats.totalDistance >= 250 },
            marathoner: { icon: 'üèÜ', title: 'Future Marathoner', desc: 'Run 500km total', xp: 1000, category: 'performance', check: () => gameStats.totalDistance >= 500 },
            ultraRunner: { icon: 'ü¶Ö', title: 'Ultra Runner', desc: 'Run 1000km total', xp: 2000, category: 'performance', check: () => gameStats.totalDistance >= 1000 },
            speedDemon: { icon: '‚ö°', title: 'Speed Demon', desc: 'Complete 5 speed workouts', xp: 250, category: 'performance', check: () => Array.from(completedWorkouts).filter(id => getWorkoutById(id)?.type === 'speed').length >= 5 },
            tempoMaster: { icon: 'üéµ', title: 'Tempo Master', desc: 'Complete 5 tempo runs', xp: 250, category: 'performance', check: () => Array.from(completedWorkouts).filter(id => getWorkoutById(id)?.type === 'tempo').length >= 5 },
            longRunHero: { icon: 'ü¶Å', title: 'Long Run Hero', desc: 'Complete 5 long runs', xp: 300, category: 'performance', check: () => Array.from(completedWorkouts).filter(id => getWorkoutById(id)?.type === 'long').length >= 5 },
            
            // Special Category
            pointCollector: { icon: 'üí∞', title: 'XP Collector', desc: 'Earn 1000 XP', xp: 200, category: 'special', check: () => gameStats.experience >= 1000 },
            pointMaster: { icon: 'üëë', title: 'XP Master', desc: 'Earn 5000 XP', xp: 500, category: 'special', check: () => gameStats.experience >= 5000 },
            levelUp5: { icon: 'üåü', title: 'Rising Star', desc: 'Reach level 5', xp: 300, category: 'special', check: () => gameStats.level >= 5 },
            levelUp10: { icon: 'üí´', title: 'Training Master', desc: 'Reach level 10', xp: 600, category: 'special', check: () => gameStats.level >= 10 },
            achievementHunter: { icon: 'üéñÔ∏è', title: 'Achievement Hunter', desc: 'Unlock 15 achievements', xp: 400, category: 'special', check: () => gameStats.achievements.size >= 15 },
            challengeChampion: { icon: 'üèÖ', title: 'Challenge Champion', desc: 'Complete 10 daily challenges', xp: 350, category: 'special', check: () => checkChallengeCount() },
            perfectionist: { icon: 'üíé', title: 'Perfectionist', desc: 'Complete 5 perfect weeks', xp: 800, category: 'special', check: () => gameStats.weeklyGoalStreak >= 5 }
        };

        // Experience and level system
        const XP_PER_LEVEL = 100;
        const workoutXP = {
            'long': 50,
            'tempo': 30,
            'speed': 40,
            'easy': 20
        };

        // Daily & Weekly Challenges
        const dailyChallenges = [
            { desc: 'Complete any workout today', xp: 50, check: () => checkDailyWorkout() },
            { desc: 'Run at least 5km today', xp: 75, check: () => checkDailyDistance(5) },
            { desc: 'Complete a tempo run today', xp: 60, check: () => checkDailyWorkoutType('tempo') },
            { desc: 'Complete a speed workout today', xp: 70, check: () => checkDailyWorkoutType('speed') },
            { desc: 'Maintain your streak today', xp: 40, check: () => checkStreakMaintained() }
        ];

        const weeklyChallenges = [
            { desc: 'Complete 3 workouts this week', xp: 150, goal: 3, check: () => checkWeeklyWorkouts(3) },
            { desc: 'Run 20km total this week', xp: 200, goal: 20, check: () => checkWeeklyDistance(20) },
            { desc: 'Complete all 3 workout types', xp: 250, goal: 3, check: () => checkAllWorkoutTypes() },
            { desc: 'Complete 4 workouts this week', xp: 300, goal: 4, check: () => checkWeeklyWorkouts(4) },
            { desc: 'Run 30km total this week', xp: 350, goal: 30, check: () => checkWeeklyDistance(30) }
        ];

        // Motivational messages
        const motivationalMessages = [
            "You're doing great! üí™",
            "Keep up the momentum! üöÄ",
            "Every step counts! üëü",
            "You're stronger than yesterday! üíØ",
            "Excellence is a habit! ‚≠ê",
            "Push beyond your limits! üî•",
            "Your future self will thank you! üôå"
        ];

        function getWorkoutById(workoutId) {
            for (let week in trainingPlan) {
                const workout = trainingPlan[week].workouts.find(w => w.id === workoutId);
                if (workout) return workout;
            }
            return null;
        }

        function checkPerfectWeek() {
            const weekPlan = trainingPlan[currentWeek];
            if (!weekPlan) return false;
            return weekPlan.workouts.every(workout => workout.completed);
        }

        function checkChallengeCount() {
            // This would normally track completed challenges
            return false; // Placeholder
        }

        // Challenge checking functions
        function checkDailyWorkout() {
            const today = new Date().toDateString();
            return Array.from(completedWorkouts).some(id => {
                const workout = workoutHistory[id];
                return workout && new Date(workout.completedAt).toDateString() === today;
            });
        }

        function checkDailyDistance(targetDistance) {
            const today = new Date().toDateString();
            let totalDistance = 0;
            Array.from(completedWorkouts).forEach(id => {
                const workout = workoutHistory[id];
                if (workout && new Date(workout.completedAt).toDateString() === today) {
                    totalDistance += workout.distance;
                }
            });
            return totalDistance >= targetDistance;
        }

        function checkDailyWorkoutType(type) {
            const today = new Date().toDateString();
            return Array.from(completedWorkouts).some(id => {
                const workout = workoutHistory[id];
                const workoutData = getWorkoutById(id);
                return workout && workoutData && 
                       new Date(workout.completedAt).toDateString() === today &&
                       workoutData.type === type;
            });
        }

        function checkStreakMaintained() {
            return gameStats.currentStreak > 0;
        }

        function checkWeeklyWorkouts(target) {
            const weekWorkouts = getThisWeekWorkouts();
            return weekWorkouts.length >= target;
        }

        function checkWeeklyDistance(target) {
            const weekWorkouts = getThisWeekWorkouts();
            const totalDistance = weekWorkouts.reduce((sum, w) => sum + w.distance, 0);
            return totalDistance >= target;
        }

        function checkAllWorkoutTypes() {
            const weekWorkouts = getThisWeekWorkouts();
            const types = new Set(weekWorkouts.map(w => getWorkoutById(w.id)?.type));
            return types.size >= 3;
        }

        function getThisWeekWorkouts() {
            const startOfWeek = new Date();
            startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay() + 1);
            startOfWeek.setHours(0, 0, 0, 0);
            
            return Array.from(completedWorkouts).map(id => workoutHistory[id])
                .filter(w => w && new Date(w.completedAt) >= startOfWeek);
        }

        function getStreakMultiplier() {
            if (gameStats.currentStreak >= 21) return 2.0;
            if (gameStats.currentStreak >= 14) return 1.5;
            if (gameStats.currentStreak >= 7) return 1.2;
            return 1.0;
        }

        function calculateLevel(xp) {
            return Math.floor(xp / XP_PER_LEVEL) + 1;
        }

        function getXPForNextLevel(level) {
            return level * XP_PER_LEVEL;
        }

        function getCurrentLevelXP(xp, level) {
            return xp - ((level - 1) * XP_PER_LEVEL);
        }

        function generateDailyChallenge() {
            const today = new Date().toDateString();
            if (!gameStats.lastChallengeReset || gameStats.lastChallengeReset !== today) {
                gameStats.dailyChallenge = dailyChallenges[Math.floor(Math.random() * dailyChallenges.length)];
                gameStats.dailyChallenge.completed = false;
                gameStats.lastChallengeReset = today;
            }
        }

        function generateWeeklyChallenge() {
            const startOfWeek = new Date();
            startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay() + 1);
            const weekKey = startOfWeek.toISOString().split('T')[0];
            
            if (!gameStats.weeklyChallenge || gameStats.weeklyChallenge.week !== weekKey) {
                gameStats.weeklyChallenge = {
                    ...weeklyChallenges[Math.floor(Math.random() * weeklyChallenges.length)],
                    completed: false,
                    week: weekKey
                };
            }
        }

        function updateStats() {
            // Update XP and level
            const newLevel = calculateLevel(gameStats.experience);
            if (newLevel > gameStats.level) {
                showLevelUp(newLevel);
                gameStats.level = newLevel;
            }
            
            const currentLevelXP = getCurrentLevelXP(gameStats.experience, gameStats.level);
            const nextLevelXP = XP_PER_LEVEL;
            const xpProgress = (currentLevelXP / nextLevelXP) * 100;
            
            document.getElementById('currentLevel').textContent = gameStats.level;
            document.getElementById('currentXP').textContent = currentLevelXP;
            document.getElementById('nextLevelXP').textContent = nextLevelXP;
            document.getElementById('xpBar').style.width = `${xpProgress}%`;
            document.getElementById('totalXP').textContent = `${gameStats.experience} XP`;
            
            // Update multiplier
            const multiplier = getStreakMultiplier();
            document.getElementById('streakMultiplier').textContent = multiplier.toFixed(1);
            
            // Update streak with fire animation
            document.getElementById('currentStreak').textContent = `${gameStats.currentStreak} days`;
            document.getElementById('longestStreak').textContent = gameStats.longestStreak;
            const streakIcon = document.getElementById('streakIcon');
            if (gameStats.currentStreak >= 7) {
                streakIcon.className = 'text-3xl animate-streak-fire';
                streakIcon.textContent = 'üî•';
            } else {
                streakIcon.className = 'text-3xl';
                streakIcon.textContent = 'üî•';
            }
            
            // Update distance and records
            document.getElementById('totalDistance').textContent = `${gameStats.totalDistance.toFixed(1)} km`;
            document.getElementById('longestRun').textContent = gameStats.personalRecords.longestRun.toFixed(1);
            
            // Update achievements count
            document.getElementById('achievementCount').textContent = `${gameStats.achievements.size}/${Object.keys(achievements).length}`;
            document.getElementById('weeklyStreak').textContent = gameStats.weeklyGoalStreak;
            
            // Update motivational message
            const messages = motivationalMessages;
            const randomMessage = messages[Math.floor(Math.random() * messages.length)];
            document.getElementById('motivationalMessage').textContent = randomMessage;
            
            // Update week progress
            updateWeekProgress();
            
            // Update challenges
            updateChallenges();
        }

        function updateWeekProgress() {
            const weekPlan = trainingPlan[currentWeek];
            if (!weekPlan) return;
            
            const totalWorkouts = weekPlan.workouts.length;
            const completedCount = weekPlan.workouts.filter(w => w.completed).length;
            const progressPercent = totalWorkouts > 0 ? (completedCount / totalWorkouts) * 100 : 0;
            
            document.getElementById('weekProgressBar').style.width = `${progressPercent}%`;
            document.getElementById('weekProgressPercent').textContent = `(${Math.round(progressPercent)}%)`;
            document.getElementById('completedWorkouts').textContent = `${completedCount}/${totalWorkouts}`;
            
            // Calculate week distance and XP
            let weekDistance = 0;
            let weekXP = 0;
            weekPlan.workouts.forEach(workout => {
                if (workout.completed) {
                    const history = workoutHistory[workout.id];
                    weekDistance += history ? history.distance : workout.distance;
                    const baseXP = workoutXP[workout.type] || 0;
                    weekXP += Math.floor(baseXP * getStreakMultiplier());
                }
            });
            
            document.getElementById('weekDistance').textContent = `${weekDistance.toFixed(1)} km`;
            document.getElementById('weekXP').textContent = `${weekXP} XP`;
        }

        function updateChallenges() {
            generateDailyChallenge();
            generateWeeklyChallenge();
            
            // Update daily challenge
            const dailyChallenge = gameStats.dailyChallenge;
            if (dailyChallenge) {
                document.getElementById('dailyChallengeDesc').textContent = dailyChallenge.desc;
                document.getElementById('dailyChallengeReward').textContent = `+${dailyChallenge.xp} XP`;
                
                const completed = dailyChallenge.check();
                if (completed && !dailyChallenge.completed) {
                    dailyChallenge.completed = true;
                    showChallengeComplete('Daily Challenge', dailyChallenge.xp);
                    gameStats.experience += dailyChallenge.xp;
                }
                
                document.getElementById('dailyChallengeStatus').textContent = completed ? 'Complete!' : 'Active';
                document.getElementById('dailyChallengeStatus').className = `text-xs px-2 py-1 rounded ${completed ? 'bg-green-500 bg-opacity-30' : 'bg-white bg-opacity-20'}`;
            }
            
            // Update weekly challenge
            const weeklyChallenge = gameStats.weeklyChallenge;
            if (weeklyChallenge) {
                document.getElementById('weeklyChallengeDesc').textContent = weeklyChallenge.desc;
                document.getElementById('weeklyChallengeReward').textContent = `+${weeklyChallenge.xp} XP`;
                
                const completed = weeklyChallenge.check();
                if (completed && !weeklyChallenge.completed) {
                    weeklyChallenge.completed = true;
                    showChallengeComplete('Weekly Challenge', weeklyChallenge.xp);
                    gameStats.experience += weeklyChallenge.xp;
                }
                
                if (weeklyChallenge.goal) {
                    const progress = getWeeklyProgress(weeklyChallenge);
                    document.getElementById('weeklyProgress').textContent = progress;
                    document.getElementById('weeklyGoal').textContent = weeklyChallenge.goal;
                } else {
                    document.getElementById('weeklyChallengeStatus').textContent = completed ? 'Complete!' : 'Active';
                }
            }
            
            // Update timers
            updateChallengeTimers();
        }

        function getWeeklyProgress(challenge) {
            if (challenge.desc.includes('workouts')) {
                return getThisWeekWorkouts().length;
            } else if (challenge.desc.includes('km')) {
                return Math.floor(getThisWeekWorkouts().reduce((sum, w) => sum + w.distance, 0));
            } else if (challenge.desc.includes('types')) {
                const types = new Set(getThisWeekWorkouts().map(w => getWorkoutById(w.id)?.type));
                return types.size;
            }
            return 0;
        }

        function updateChallengeTimers() {
            // Daily timer
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0);
            const timeToTomorrow = tomorrow - now;
            const hoursLeft = Math.floor(timeToTomorrow / (1000 * 60 * 60));
            const minutesLeft = Math.floor((timeToTomorrow % (1000 * 60 * 60)) / (1000 * 60));
            document.getElementById('dailyChallengeTimer').textContent = `${hoursLeft}h ${minutesLeft}m left`;
            
            // Weekly timer
            const nextWeek = new Date(now);
            nextWeek.setDate(nextWeek.getDate() + (7 - nextWeek.getDay() + 1));
            nextWeek.setHours(0, 0, 0, 0);
            const timeToNextWeek = nextWeek - now;
            const daysLeft = Math.floor(timeToNextWeek / (1000 * 60 * 60 * 24));
            const weekHoursLeft = Math.floor((timeToNextWeek % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            document.getElementById('weeklyChallengeTimer').textContent = `${daysLeft}d ${weekHoursLeft}h left`;
        }

        function checkAchievements() {
            const newAchievements = [];
            
            Object.entries(achievements).forEach(([key, achievement]) => {
                if (!gameStats.achievements.has(key) && achievement.check()) {
                    gameStats.achievements.add(key);
                    gameStats.experience += achievement.xp;
                    newAchievements.push({ key, ...achievement });
                }
            });
            
            if (newAchievements.length > 0) {
                gameStats.newAchievements = newAchievements;
                document.getElementById('newAchievementBadge').classList.remove('hidden');
                showAchievementEarned(newAchievements[0]);
            }
            
            updateStats();
        }

        function updatePersonalRecords(workout, actualDistance, actualPace) {
            // Update longest run
            if (actualDistance > gameStats.personalRecords.longestRun) {
                gameStats.personalRecords.longestRun = actualDistance;
            }
            
            // Update fastest pace (convert pace string to seconds for comparison)
            const paceInSeconds = paceToSeconds(actualPace);
            if (!gameStats.personalRecords.fastestPace || paceInSeconds < paceToSeconds(gameStats.personalRecords.fastestPace)) {
                gameStats.personalRecords.fastestPace = actualPace;
            }
            
            // Update daily XP record
            const today = new Date().toDateString();
            const todayWorkouts = Array.from(completedWorkouts).filter(id => {
                const w = workoutHistory[id];
                return w && new Date(w.completedAt).toDateString() === today;
            });
            const todayXP = todayWorkouts.reduce((sum, id) => {
                const w = getWorkoutById(id);
                return sum + (workoutXP[w?.type] || 0);
            }, 0);
            
            if (todayXP > gameStats.personalRecords.mostXPInDay) {
                gameStats.personalRecords.mostXPInDay = todayXP;
            }
        }

        function paceToSeconds(paceString) {
            const [minutes, seconds] = paceString.split(':').map(Number);
            return minutes * 60 + seconds;
        }

        function showLevelUp(newLevel) {
            document.getElementById('newLevel').textContent = newLevel;
            document.getElementById('newMultiplier').textContent = getStreakMultiplier().toFixed(1);
            document.getElementById('levelUpModal').classList.remove('hidden');
            createConfetti();
        }

        function showAchievementEarned(achievement) {
            document.getElementById('earnedMedalIcon').textContent = achievement.icon;
            document.getElementById('earnedAchievementTitle').textContent = achievement.title;
            document.getElementById('earnedAchievementDesc').textContent = achievement.desc;
            document.getElementById('earnedXP').textContent = achievement.xp;
            
            document.getElementById('achievementEarnedModal').classList.remove('hidden');
            createConfetti();
        }

        function showChallengeComplete(challengeType, xp) {
            document.getElementById('completedChallengeTitle').textContent = challengeType;
            document.getElementById('challengeXP').textContent = xp;
            document.getElementById('challengeCompleteModal').classList.remove('hidden');
        }

        function createConfetti() {
            const overlay = document.getElementById('celebrationOverlay');
            overlay.classList.remove('hidden');
            overlay.innerHTML = '';
            
            const colors = ['#5D5CDE', '#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#FFD700'];
            
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti-piece';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDelay = Math.random() * 3 + 's';
                    overlay.appendChild(confetti);
                    
                    setTimeout(() => confetti.remove(), 3000);
                }, i * 50);
            }
            
            setTimeout(() => overlay.classList.add('hidden'), 4000);
        }

        function renderAchievements(filterCategory = 'all') {
            const container = document.getElementById('achievementsList');
            container.innerHTML = '';
            
            Object.entries(achievements).forEach(([key, achievement]) => {
                if (filterCategory !== 'all' && achievement.category !== filterCategory) return;
                
                const earned = gameStats.achievements.has(key);
                const div = document.createElement('div');
                div.className = `p-4 rounded-lg border-2 transition-all ${earned ? 'bg-yellow-50 dark:bg-yellow-900/20 border-yellow-300 dark:border-yellow-700' : 'bg-gray-50 dark:bg-gray-800 border-gray-200 dark:border-gray-700 opacity-60'}`;
                
                div.innerHTML = `
                    <div class="text-center">
                        <div class="text-3xl mb-2 ${earned ? 'animate-pulse' : 'grayscale'}">${achievement.icon}</div>
                        <h4 class="font-semibold mb-1">${achievement.title}</h4>
                        <p class="text-xs text-gray-600 dark:text-gray-400 mb-2">${achievement.desc}</p>
                        <div class="text-xs mb-1">
                            <span class="bg-${achievement.category === 'progress' ? 'blue' : achievement.category === 'consistency' ? 'green' : achievement.category === 'performance' ? 'purple' : 'orange'}-100 dark:bg-${achievement.category === 'progress' ? 'blue' : achievement.category === 'consistency' ? 'green' : achievement.category === 'performance' ? 'purple' : 'orange'}-900/20 text-${achievement.category === 'progress' ? 'blue' : achievement.category === 'consistency' ? 'green' : achievement.category === 'performance' ? 'purple' : 'orange'}-600 dark:text-${achievement.category === 'progress' ? 'blue' : achievement.category === 'consistency' ? 'green' : achievement.category === 'performance' ? 'purple' : 'orange'}-400 px-2 py-1 rounded text-xs">${achievement.category}</span>
                        </div>
                        <div class="text-sm font-medium ${earned ? 'text-yellow-600 dark:text-yellow-400' : 'text-gray-500'}">
                            ${earned ? '‚úì Earned!' : `${achievement.xp} XP`}
                        </div>
                    </div>
                `;
                
                container.appendChild(div);
            });
        }

        function renderPersonalRecords() {
            const container = document.getElementById('personalRecords');
            const records = [
                { icon: 'üèÉ‚Äç‚ôÇÔ∏è', title: 'Longest Run', value: `${gameStats.personalRecords.longestRun.toFixed(1)} km` },
                { icon: '‚ö°', title: 'Fastest Pace', value: gameStats.personalRecords.fastestPace || 'N/A' },
                { icon: 'üî•', title: 'Best Daily XP', value: `${gameStats.personalRecords.mostXPInDay} XP` },
                { icon: 'üèÜ', title: 'Longest Streak', value: `${gameStats.longestStreak} days` },
                { icon: 'üí™', title: 'Current Level', value: `Level ${gameStats.level}` },
                { icon: '‚≠ê', title: 'Total XP', value: `${gameStats.experience} XP` }
            ];
            
            container.innerHTML = records.map(record => `
                <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg flex items-center gap-3">
                    <div class="text-2xl">${record.icon}</div>
                    <div>
                        <div class="font-semibold text-sm">${record.title}</div>
                        <div class="text-primary font-bold record-badge">${record.value}</div>
                    </div>
                </div>
            `).join('');
        }

        function renderProgressMilestones() {
            const container = document.getElementById('progressMilestones');
            const milestones = [
                { title: 'Total Distance', current: gameStats.totalDistance, target: 100, unit: 'km' },
                { title: 'Workouts Completed', current: completedWorkouts.size, target: 50, unit: '' },
                { title: 'Current Streak', current: gameStats.currentStreak, target: 30, unit: ' days' },
                { title: 'Experience Points', current: gameStats.experience, target: 5000, unit: ' XP' }
            ];
            
            container.innerHTML = milestones.map(milestone => {
                const progress = Math.min((milestone.current / milestone.target) * 100, 100);
                return `
                    <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-semibold text-sm">${milestone.title}</span>
                            <span class="text-xs text-gray-600 dark:text-gray-400">${milestone.current.toFixed(1)}${milestone.unit} / ${milestone.target}${milestone.unit}</span>
                        </div>
                        <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                            <div class="bg-gradient-to-r from-primary to-purple-600 h-2 rounded-full transition-all duration-500" style="width: ${progress}%"></div>
                        </div>
                        <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">${progress.toFixed(1)}% complete</div>
                    </div>
                `;
            }).join('');
        }

        function updateStreak(completedDate) {
            const today = new Date();
            const completed = new Date(completedDate);
            
            if (gameStats.lastWorkoutDate) {
                const lastDate = new Date(gameStats.lastWorkoutDate);
                const daysDiff = Math.floor((completed - lastDate) / (1000 * 60 * 60 * 24));
                
                if (daysDiff === 1) {
                    gameStats.currentStreak++;
                } else if (daysDiff > 1) {
                    gameStats.currentStreak = 1;
                }
            } else {
                gameStats.currentStreak = 1;
            }
            
            gameStats.longestStreak = Math.max(gameStats.longestStreak, gameStats.currentStreak);
            gameStats.lastWorkoutDate = completedDate;
        }

        // Training plan generation (unchanged)
        function generateTrainingPlan(weeks = 40) {
            const plan = {};
            const startingLongRun = 10;
            
            for (let week = 1; week <= weeks; week++) {
                plan[week] = generateWeekPlan(week, weeks, startingLongRun);
            }
            
            return plan;
        }

        function generateWeekPlan(weekNum, totalWeeks, startingLongRun) {
            const phase = getTrainingPhase(weekNum, totalWeeks);
            const isRecoveryWeek = weekNum % 4 === 0;
            const isTaperWeek = weekNum > totalWeeks - 3;
            
            let longRunDistance = calculateLongRunDistance(weekNum, totalWeeks, startingLongRun, isRecoveryWeek, isTaperWeek);
            let tempoDistance = calculateTempoDistance(weekNum, totalWeeks, isRecoveryWeek, isTaperWeek);
            let speedWorkout = generateSpeedWorkout(weekNum, totalWeeks, isRecoveryWeek, isTaperWeek);

            return {
                phase: phase,
                workouts: [
                    {
                        id: `${weekNum}-1`,
                        type: 'tempo',
                        name: 'Tempo Run',
                        distance: tempoDistance,
                        pace: 'tempoRun',
                        details: `${tempoDistance}km at tempo pace`,
                        day: 'tuesday',
                        completed: false
                    },
                    {
                        id: `${weekNum}-2`,
                        type: 'speed',
                        name: 'Speed/Interval',
                        distance: speedWorkout.distance,
                        pace: 'speedRun',
                        details: speedWorkout.details,
                        day: 'thursday',
                        completed: false
                    },
                    {
                        id: `${weekNum}-3`,
                        type: 'long',
                        name: 'Long Run',
                        distance: longRunDistance,
                        pace: 'longRun',
                        details: `${longRunDistance}km at steady pace`,
                        day: 'sunday',
                        completed: false
                    }
                ]
            };
        }

        function getTrainingPhase(weekNum, totalWeeks) {
            if (weekNum <= totalWeeks * 0.3) return 'Base Building';
            if (weekNum <= totalWeeks * 0.6) return 'Strength Building';
            if (weekNum <= totalWeeks * 0.85) return 'Peak Training';
            return 'Taper';
        }

        function calculateLongRunDistance(weekNum, totalWeeks, startingDistance, isRecoveryWeek, isTaperWeek) {
            if (isTaperWeek) {
                const weeksFromEnd = totalWeeks - weekNum + 1;
                return Math.max(8, startingDistance - (3 - weeksFromEnd) * 3);
            }
            
            if (isRecoveryWeek) {
                return Math.max(startingDistance, startingDistance + Math.floor(weekNum / 4) * 2 - 3);
            }
            
            const progression = Math.min(33, startingDistance + Math.floor(weekNum / 2) * 1.5);
            return Math.round(progression);
        }

        function calculateTempoDistance(weekNum, totalWeeks, isRecoveryWeek, isTaperWeek) {
            if (isTaperWeek) return Math.max(3, 8 - weekNum + totalWeeks - 3);
            if (isRecoveryWeek) return Math.max(4, 6 + Math.floor(weekNum / 8));
            return Math.min(10, 4 + Math.floor(weekNum / 3));
        }

        function generateSpeedWorkout(weekNum, totalWeeks, isRecoveryWeek, isTaperWeek) {
            const workouts = [
                { distance: 3, details: '6x400m @ speed pace (1:00 recovery)' },
                { distance: 4, details: '4x800m @ speed pace (90s recovery)' },
                { distance: 5, details: '5x600m @ speed pace (75s recovery)' },
                { distance: 4, details: '5km fartlek (1:00 hard / 2:00 easy)' },
                { distance: 5, details: '6x800m @ speed pace (90s recovery)' },
                { distance: 6, details: '6km progression (last 2km @ speed pace)' },
                { distance: 5, details: '5x1000m @ speed pace (2:00 recovery)' },
                { distance: 4, details: '4x1km @ speed pace (2:00 recovery)' },
                { distance: 4, details: '6x600m @ speed pace (75s recovery)' },
                { distance: 3, details: '3x1.5km @ speed pace (2:30 recovery)' }
            ];
            
            if (isTaperWeek) {
                return { distance: 3, details: 'Light strides and drills' };
            }
            
            return workouts[weekNum % workouts.length];
        }

        // Calendar functions (unchanged)
        function getWeekDates(weekNum) {
            const startDate = new Date();
            startDate.setDate(startDate.getDate() + (weekNum - 1) * 7);
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + 6);
            
            return {
                start: startDate,
                end: endDate,
                formatted: `${formatDate(startDate)}-${formatDate(endDate)}`
            };
        }

        function formatDate(date) {
            return `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}`;
        }

        function getDayOfWeek(day) {
            const days = {
                'monday': 0, 'tuesday': 1, 'wednesday': 2, 'thursday': 3,
                'friday': 4, 'saturday': 5, 'sunday': 6
            };
            return days[day] || 0;
        }

        // Rendering functions
        function renderCalendar() {
            const weekDates = getWeekDates(currentWeek);
            document.getElementById('weekTitle').textContent = `Week ${currentWeek}`;
            document.getElementById('weekDates').textContent = weekDates.formatted;
            
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            
            days.forEach((day, index) => {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'min-h-32 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-3';
                dayDiv.dataset.day = day.toLowerCase();
                
                const dayHeader = document.createElement('h4');
                dayHeader.className = 'font-semibold text-sm mb-2 text-center';
                dayHeader.textContent = day;
                dayDiv.appendChild(dayHeader);
                
                const workoutContainer = document.createElement('div');
                workoutContainer.className = 'space-y-2 workout-container';
                dayDiv.appendChild(workoutContainer);
                
                grid.appendChild(dayDiv);
                
                // Make containers sortable
                new Sortable(workoutContainer, {
                    group: 'workouts',
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    onEnd: function(evt) {
                        updateWorkoutDay(evt.item.dataset.workoutId, evt.to.parentElement.dataset.day);
                    }
                });
            });
            
            renderWorkouts();
            updateStats();
        }

        function renderWorkouts() {
            const weekPlan = trainingPlan[currentWeek];
            if (!weekPlan) return;
            
            // Clear all containers
            document.querySelectorAll('.workout-container').forEach(container => {
                container.innerHTML = '';
            });
            
            weekPlan.workouts.forEach(workout => {
                const workoutElement = createWorkoutElement(workout);
                const dayContainer = document.querySelector(`[data-day="${workout.day}"] .workout-container`);
                if (dayContainer) {
                    dayContainer.appendChild(workoutElement);
                }
            });
        }

        function createWorkoutElement(workout) {
            const div = document.createElement('div');
            const xp = workoutXP[workout.type] || 0;
            const multiplier = getStreakMultiplier();
            const totalXP = Math.floor(xp * multiplier);
            
            div.className = `workout-card bg-white dark:bg-gray-900 border-2 border-l-4 rounded-lg p-3 cursor-pointer ${getWorkoutBorderColor(workout.type)} ${workout.completed ? 'opacity-70 bg-green-50 dark:bg-green-900/20' : 'hover:shadow-lg'}`;
            div.dataset.workoutId = workout.id;
            
            const currentPace = paces[workout.pace] || workout.pace;
            
            div.innerHTML = `
                <div class="flex items-center justify-between mb-1">
                    <h5 class="font-semibold text-sm">${workout.name}</h5>
                    ${workout.completed ? '<span class="text-green-600 text-xs">‚úì Done</span>' : `<span class="text-primary text-xs font-medium">${totalXP} XP</span>`}
                </div>
                <p class="text-xs text-gray-600 dark:text-gray-400">${workout.distance}km @ ${currentPace}/km</p>
                <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">${workout.details}</p>
                ${multiplier > 1.0 && !workout.completed ? `<p class="text-xs text-orange-500 font-medium mt-1">üî• ${multiplier}x streak bonus!</p>` : ''}
            `;
            
            div.addEventListener('click', () => openWorkoutModal(workout));
            
            return div;
        }

        function getWorkoutBorderColor(type) {
            const colors = {
                'long': 'border-l-longRun border-longRun/20',
                'tempo': 'border-l-tempoRun border-tempoRun/20',
                'speed': 'border-l-speedRun border-speedRun/20',
                'easy': 'border-l-easyRun border-easyRun/20'
            };
            return colors[type] || 'border-l-gray-400 border-gray-200';
        }

        // Modal functions
        function openPaceModal() {
            document.getElementById('paceModal').classList.remove('hidden');
            
            // Populate current paces
            document.getElementById('longRunPace').value = paces.longRun;
            document.getElementById('tempoRunPace').value = paces.tempoRun;
            document.getElementById('speedRunPace').value = paces.speedRun;
            document.getElementById('easyRunPace').value = paces.easyRun;
            document.getElementById('marathonPace').value = paces.marathon;
        }

        function closePaceModal() {
            document.getElementById('paceModal').classList.add('hidden');
        }

        function savePaces() {
            paces.longRun = document.getElementById('longRunPace').value;
            paces.tempoRun = document.getElementById('tempoRunPace').value;
            paces.speedRun = document.getElementById('speedRunPace').value;
            paces.easyRun = document.getElementById('easyRunPace').value;
            paces.marathon = document.getElementById('marathonPace').value;
            
            renderWorkouts();
            closePaceModal();
            saveToLocalStorage();
        }

        function openAchievementsModal() {
            document.getElementById('achievementsModal').classList.remove('hidden');
            document.getElementById('newAchievementBadge').classList.add('hidden');
            gameStats.newAchievements = [];
            renderAchievements();
        }

        function closeAchievementsModal() {
            document.getElementById('achievementsModal').classList.add('hidden');
        }

        function openChallengesModal() {
            document.getElementById('challengesModal').classList.remove('hidden');
            renderPersonalRecords();
            renderProgressMilestones();
        }

        function closeChallengesModal() {
            document.getElementById('challengesModal').classList.add('hidden');
        }

        function openWorkoutModal(workout) {
            const modal = document.getElementById('workoutModal');
            const currentPace = paces[workout.pace] || workout.pace;
            const baseXP = workoutXP[workout.type] || 0;
            const multiplier = getStreakMultiplier();
            const totalXP = Math.floor(baseXP * multiplier);
            
            document.getElementById('workoutTitle').textContent = workout.name;
            document.getElementById('workoutContent').innerHTML = `
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg mb-4">
                    <h4 class="font-semibold mb-2">Planned Workout</h4>
                    <p><strong>Distance:</strong> ${workout.distance}km</p>
                    <p><strong>Pace:</strong> ${currentPace}/km</p>
                    <p><strong>Details:</strong> ${workout.details}</p>
                    <p class="text-primary font-semibold mt-2">üèÜ Worth ${totalXP} XP!</p>
                    ${multiplier > 1.0 ? `<p class="text-orange-500 font-medium mt-1">üî• Includes ${multiplier}x streak bonus!</p>` : ''}
                </div>
            `;
            
            // Pre-fill with planned values
            document.getElementById('actualDistance').value = workout.distance;
            document.getElementById('actualPace').value = currentPace;
            document.getElementById('effortLevel').value = 5;
            document.getElementById('effortValue').textContent = '5';
            
            // Load saved data if exists
            const savedData = workoutHistory[workout.id];
            if (savedData) {
                document.getElementById('actualDistance').value = savedData.distance || workout.distance;
                document.getElementById('actualPace').value = savedData.pace || currentPace;
                document.getElementById('effortLevel').value = savedData.effort || 5;
                document.getElementById('effortValue').textContent = savedData.effort || '5';
                document.getElementById('workoutNotes').value = savedData.notes || '';
            } else {
                document.getElementById('workoutNotes').value = '';
            }
            
            modal.dataset.workoutId = workout.id;
            modal.classList.remove('hidden');
        }

        function closeWorkoutModal() {
            document.getElementById('workoutModal').classList.add('hidden');
        }

        function completeWorkout() {
            const workoutId = document.getElementById('workoutModal').dataset.workoutId;
            const distance = parseFloat(document.getElementById('actualDistance').value);
            const pace = document.getElementById('actualPace').value;
            const effort = parseInt(document.getElementById('effortLevel').value);
            const notes = document.getElementById('workoutNotes').value;
            const completedAt = new Date().toISOString();
            
            // Save workout data
            workoutHistory[workoutId] = {
                distance: distance,
                pace: pace,
                effort: effort,
                notes: notes,
                completedAt: completedAt
            };
            
            // Mark as completed
            completedWorkouts.add(workoutId);
            
            // Update the workout in the plan
            const weekPlan = trainingPlan[currentWeek];
            const workout = weekPlan.workouts.find(w => w.id === workoutId);
            if (workout) {
                workout.completed = true;
                
                // Update game stats with XP and multiplier
                const baseXP = workoutXP[workout.type] || 0;
                const multiplier = getStreakMultiplier();
                const totalXP = Math.floor(baseXP * multiplier);
                gameStats.experience += totalXP;
                gameStats.totalDistance += distance;
                
                // Update personal records
                updatePersonalRecords(workout, distance, pace);
                
                // Update streak
                updateStreak(completedAt);
                
                // Check for achievements
                checkAchievements();
                
                // Show XP gain animation
                showXPGain(totalXP);
            }
            
            renderWorkouts();
            closeWorkoutModal();
            saveToLocalStorage();
            
            // Show completion celebration
            createConfetti();
        }

        function showXPGain(xp) {
            // Create floating XP text
            const xpElement = document.createElement('div');
            xpElement.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-2xl font-bold text-yellow-500 pointer-events-none z-50 animate-xp-gain';
            xpElement.textContent = `+${xp} XP`;
            document.body.appendChild(xpElement);
            
            setTimeout(() => xpElement.remove(), 1000);
        }

        function updateWorkoutDay(workoutId, newDay) {
            const weekPlan = trainingPlan[currentWeek];
            const workout = weekPlan.workouts.find(w => w.id === workoutId);
            if (workout) {
                workout.day = newDay;
            }
            saveToLocalStorage();
        }

        // Navigation
        function changeWeek(direction) {
            const totalWeeks = parseInt(document.getElementById('planDuration').value);
            if (direction === 'next' && currentWeek < totalWeeks) {
                currentWeek++;
            } else if (direction === 'prev' && currentWeek > 1) {
                currentWeek--;
            }
            renderCalendar();
            saveToLocalStorage();
        }

        // Local Storage
        const LS_KEY = 'marathonTrainingAppV2';

        function saveToLocalStorage() {
            const data = {
                currentWeek,
                trainingPlan,
                completedWorkouts: Array.from(completedWorkouts),
                paces,
                workoutHistory,
                gameStats: {
                    ...gameStats,
                    achievements: Array.from(gameStats.achievements),
                    newAchievements: []
                }
            };
            try {
                localStorage.setItem(LS_KEY, JSON.stringify(data));
            } catch (e) {
                console.warn('Failed to save to localStorage:', e);
            }
        }

        function loadFromLocalStorage() {
            try {
                const raw = localStorage.getItem(LS_KEY);
                if (!raw) return false;
                
                const data = JSON.parse(raw);
                currentWeek = data.currentWeek || 1;
                trainingPlan = data.trainingPlan || {};
                completedWorkouts = new Set(data.completedWorkouts || []);
                paces = data.paces || {
                    longRun: '6:00',
                    tempoRun: '5:30',
                    speedRun: '5:00',
                    easyRun: '6:30',
                    marathon: '5:41'
                };
                workoutHistory = data.workoutHistory || {};
                gameStats = {
                    ...gameStats,
                    ...data.gameStats,
                    achievements: new Set(data.gameStats?.achievements || []),
                    newAchievements: []
                };
                
                // Hydrate .completed property for UI
                for (let week in trainingPlan) {
                    if (trainingPlan[week] && Array.isArray(trainingPlan[week].workouts)) {
                        trainingPlan[week].workouts.forEach(w => {
                            w.completed = completedWorkouts.has(w.id);
                        });
                    }
                }
                return true;
            } catch (e) {
                console.warn('Failed to load data from localStorage:', e);
                return false;
            }
        }

        // Event listeners
        document.getElementById('paceSettings').addEventListener('click', openPaceModal);
        document.getElementById('closePaceModal').addEventListener('click', closePaceModal);
        document.getElementById('savePaces').addEventListener('click', savePaces);
        document.getElementById('achievementsBtn').addEventListener('click', openAchievementsModal);
        document.getElementById('closeAchievementsModal').addEventListener('click', closeAchievementsModal);
        document.getElementById('challengesBtn').addEventListener('click', openChallengesModal);
        document.getElementById('closeChallengesModal').addEventListener('click', closeChallengesModal);
        document.getElementById('closeWorkoutModal').addEventListener('click', closeWorkoutModal);
        document.getElementById('completeWorkout').addEventListener('click', completeWorkout);
        document.getElementById('closeAchievementModal').addEventListener('click', () => {
            document.getElementById('achievementEarnedModal').classList.add('hidden');
        });
        document.getElementById('closeLevelUpModal').addEventListener('click', () => {
            document.getElementById('levelUpModal').classList.add('hidden');
        });
        document.getElementById('closeChallengeModal').addEventListener('click', () => {
            document.getElementById('challengeCompleteModal').classList.add('hidden');
        });
        document.getElementById('nextWeek').addEventListener('click', () => changeWeek('next'));
        document.getElementById('prevWeek').addEventListener('click', () => changeWeek('prev'));

        // Achievement filter buttons
        document.querySelectorAll('.achievement-filter-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.achievement-filter-btn').forEach(b => {
                    b.className = 'achievement-filter-btn bg-gray-200 dark:bg-gray-700 px-3 py-1 rounded text-sm';
                });
                e.target.className = 'achievement-filter-btn bg-primary text-white px-3 py-1 rounded text-sm';
                renderAchievements(e.target.dataset.category);
            });
        });

        // Effort level slider
        document.getElementById('effortLevel').addEventListener('input', (e) => {
            document.getElementById('effortValue').textContent = e.target.value;
        });

        document.getElementById('planDuration').addEventListener('change', (e) => {
            const weeks = parseInt(e.target.value);
            trainingPlan = generateTrainingPlan(weeks);
            currentWeek = 1;
            renderCalendar();
            saveToLocalStorage();
        });

        // Auto-save periodically
        setInterval(saveToLocalStorage, 30000); // Save every 30 seconds

        // Update challenge timers every minute
        setInterval(updateChallengeTimers, 60000);

        // Initialize app
        function initApp() {
            const loaded = loadFromLocalStorage();
            if (!loaded) {
                trainingPlan = generateTrainingPlan(40);
            }
            renderCalendar();
            updateStats();
            
            // Set up daily challenge reset check
            setInterval(() => {
                generateDailyChallenge();
                generateWeeklyChallenge();
                updateChallenges();
            }, 60000); // Check every minute
        }

        initApp();
    </script>
</body>
</html>